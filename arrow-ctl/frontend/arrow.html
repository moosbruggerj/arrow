<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>Arro(w)</title>
  <link rel="stylesheet" href="/static/css/bulma.min.css">
  <link rel="stylesheet" href="/static/css/fa.min.css">
  <link rel="stylesheet" href="/static/css/arrow.css">
  <script src="/static/main.js"></script>
</head>
<body>
  <script>
	let app = Elm.Main.init();
    let msgBuffer = [];
    let socket = null;
    function flush() {
      if(socket && socket.readyState == 1) { //is ready
        for (const msg of msgBuffer) {
          socket.send(JSON.stringify(msg))
        }
        msgBuffer = [];
      }
    }

    app.ports.sendMessage.subscribe(msg => {
      msgBuffer.push(msg);
      flush();
    });

	fetch("/api/client/new")
      .then(response => {
        if(!response.ok) {
          throw new Error("Network Error: Status = " + response.status);
        }
        return response.json();
      })
      .then(data => {
        let url = "ws://" + window.location.host + data.url;
        socket = new WebSocket(url);
        socket.addEventListener("open", flush); // flush all pending messages on open

        socket.addEventListener("message", event => {
          app.ports.onMessageReceived.send(JSON.parse(event.data));
        });
      })
      .catch(err => { console.log(err);
        app.ports.onMessageReceived.send({ update: { error: "Websocket error: " + err }});
      });
  </script>
</body>
</html>
